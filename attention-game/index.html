<!DOCTYPE html>
<html lang="en">
   
<head>
    <meta charset="UTF-8">
    <title>Attention Game</title>
    <link rel="stylesheet" href="style.css">
</head>
   
<body>
  <div id="screen">
      <h1 id="title">Attention Game</h1>
      <p id="subtitle">press space to continue</p>
  </div>

  <form id="demographics" class="hidden">
      <label>Name (Feel free to use a fake name, but please make sure other information is accurate) <input type="text" name="entry.280963074"></label>
      <label>Birthday (MM/DD/YR) E.g. 03/12/09 <input type="text" name="entry.90289892"></label>
      <label>Current Date (MM/DD/YR) <input type="text" name="entry.1194678358"></label>
      <label>Are you a student or teacher/administrator? <input type="text" name="entry.540422629"></label>
      <label>What grade are you in? (9, 10, 11, 12 or N/A) <input type="text" name="entry.2124972352"></label>
      <label>Are you granted extra time for testing? (No, 1.5 time, Double time or N/A) <input type="text" name="entry.1938053400"></label>
      <label>What is your current level of science? (Elective, Regular, Intensive, or N/A) <input type="text" name="entry.1666836259"></label>
      <label>What is your current level of math? (1, 3, 5, 7, or N/A) <input type="text" name="entry.1720875399"></label>
      <label>Self report your daily screen time to the best of your knowledge, feel free to check your devices. (e.g. "# hrs") <input type="text" name="entry.111459201"></label>
      <label>Specify your screen time breakdown to the best of your knowledge. (e.g. "# hour(s) social media, # hour(s) playing video games, # hour(s) google classroom") <textarea name="entry.1261445692"></textarea></label>
  

   

  

  </form>

  <div id="thankyou" class="hidden">
      <h1>Thank you for playing</h1>
  </div>

<script>
/* ======================
   DOM REFERENCES
====================== */
const screen = document.getElementById("screen");
const title = document.getElementById("title");
const subtitle = document.getElementById("subtitle");
const form = document.getElementById("demographics");
const thankyou = document.getElementById("thankyou");

/* ======================
   STATE VARIABLES
====================== */
let state = 0;
let gameActive = false;
let startTime;
let currentLetter = "";
let letterStart = null;

let gameDuration = 10 * 60 * 1000; // 10 minutes

// Trial storage
let trials = [];

/* ======================
   INPUT HANDLING
====================== */
document.addEventListener("keydown", e => {
    // Only trigger game space presses if NOT typing in a form field
    if (e.code === "Space" && e.target.tagName !== "INPUT" && e.target.tagName !== "TEXTAREA") {
        e.preventDefault();
        handleSpace();
    }
});

function handleSpace() {
    if (state === 0) showDirections();
    else if (state === 1) startGame();
    else if (gameActive) registerResponse();
}

/* ======================
   SCREENS
====================== */
function showDirections() {
    state = 1;
    title.textContent = "Directions";
    subtitle.innerHTML = `
        Pay attention to the letter shown on your screen.<br><br>
        The letter will change every few seconds.<br><br>
        Whenever the letter <strong>X</strong> appears,
        press the space bar as quickly as possible.<br><br>
        <span class="small">press space to continue</span>
    `;
}

function startGame() {
    state = 2;
    gameActive = true;
    startTime = performance.now();
    title.textContent = "";
    subtitle.textContent = "";
    runTrial();
}

/* ======================
   GAME LOGIC
====================== */
function runTrial() {
    if (performance.now() - startTime >= gameDuration) {
        endGame();
        return;
    }

    currentLetter = Math.random() < 0.2
        ? "X"
        : String.fromCharCode(65 + Math.floor(Math.random() * 26));

    letterStart = performance.now();

    trials.push({
        time: letterStart,
        letter: currentLetter,
        responded: false,
        reactionTime: null
    });

    title.textContent = currentLetter;

    setTimeout(() => {
        title.textContent = "";
        currentLetter = "";
        setTimeout(runTrial, (Math.floor(Math.random() * 3) + 1) * 1000);
    }, 250);
}

function registerResponse() {
    const lastTrial = trials[trials.length - 1];
    if (!lastTrial || lastTrial.responded) return;

    lastTrial.responded = true;

    if (lastTrial.letter === "X") {
        lastTrial.reactionTime = performance.now() - letterStart;
    }
}

/* ======================
   END GAME
====================== */
function endGame() {
    gameActive = false;
    screen.classList.add("hidden");
    form.classList.remove("hidden");

    const fields = form.querySelectorAll("input, textarea");
    fields[fields.length - 1].addEventListener("keydown", submitOnEnter);
}

/* ======================
   PERFORMANCE METRICS
====================== */
function computePerformance() {
    let correctX = 0;
    let correctIgnore = 0;
    let reactionTimes = [];

    trials.forEach(t => {
        if (t.letter === "X" && t.responded) {
            correctX++;
            reactionTimes.push(t.reactionTime);
        }
        if (t.letter !== "X" && !t.responded) {
            correctIgnore++;
        }
    });

    const accuracy =
        ((correctX + correctIgnore) / trials.length) * 100;

    const avgRT =
        reactionTimes.reduce((a, b) => a + b, 0) / reactionTimes.length;

    return { accuracy, avgRT };
}

/* ======================
   TREND CALCULATIONS
====================== */
function linearSlope(x, y) {
    const n = x.length;
    if (n < 2) return 0;

    const meanX = x.reduce((a,b)=>a+b,0) / n;
    const meanY = y.reduce((a,b)=>a+b,0) / n;

    let num = 0;
    let den = 0;

    for (let i = 0; i < n; i++) {
        num += (x[i] - meanX) * (y[i] - meanY);
        den += (x[i] - meanX) ** 2;
    }

    return den === 0 ? 0 : num / den;
}

function computeTrends(blockMs = 60000) {
    const blocks = {};

    // Group trials by time block
    trials.forEach(t => {
        const block = Math.floor((t.time - trials[0].time) / blockMs);
        if (!blocks[block]) blocks[block] = [];
        blocks[block].push(t);
    });

    const timePoints = [];
    const accuracyPoints = [];
    const reactionTimePoints = [];

    Object.keys(blocks)
        .map(Number)
        .sort((a,b) => a - b)
        .forEach(block => {

            const blockTrials = blocks[block];
            let hits = 0;
            let correctRejects = 0;
            let total = blockTrials.length;
            let rtSum = 0;
            let rtCount = 0;

            blockTrials.forEach(t => {
                if (t.letter === "X" && t.responded) {
                    hits++;
                    rtSum += t.reactionTime;
                    rtCount++;
                }
                if (t.letter !== "X" && !t.responded) {
                    correctRejects++;
                }
            });

            const accuracy = (hits + correctRejects) / total;

            timePoints.push(block * (blockMs / 60000)); // minutes
            accuracyPoints.push(accuracy);

            if (rtCount > 0) {
                reactionTimePoints.push({
                    time: block * (blockMs / 60000),
                    rt: rtSum / rtCount
                });
            }
        });

    const rtTimes = reactionTimePoints.map(p => p.time);
    const rtValues = reactionTimePoints.map(p => p.rt);

    return {
        accuracyTrend: linearSlope(timePoints, accuracyPoints),
        reactionTrend: linearSlope(rtTimes, rtValues)
    };
}


/* ======================
   FORM SUBMISSION
====================== */
function submitOnEnter(e) {
    if (e.key === "Enter") {
        e.preventDefault();
        submitForm();
    }
}

function submitForm() {
    const perf = computePerformance();
    const trends = computeTrends();

    const data = new FormData(form);

    // ðŸ”½ REPLACE ENTRY IDS
    data.append("entry.1599414603", perf.accuracy.toFixed(2));
    data.append("entry.238420684", perf.avgRT.toFixed(1));
    data.append("entry.627956812", trends.accuracyTrend.toFixed(4));
    data.append("entry.1502638983", trends.reactionTrend.toFixed(4));

    fetch("https://docs.google.com/forms/d/e/1FAIpQLSdVY3gTqkYRHXfqHcmA-AvBUbCaQJ5_Y79sMU7YvSd7adVyAg/formResponse", {
        method: "POST",
        mode: "no-cors",
        body: data
    });

    form.classList.add("hidden");
    thankyou.classList.remove("hidden");
}
</script>



















